"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};L.DomUtil.setTransform=L.DomUtil.setTransform||function(t,n,o){var e=n||new L.Point(0,0);t.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+e.x+"px,"+e.y+"px)":"translate3d("+e.x+"px,"+e.y+"px,0)")+(o?" scale("+o+")":"")},L.CanvasLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(t){this._map=null,this._canvas=null,this._frame=null,this._delegate=null,L.setOptions(this,t)},delegate:function(t){return this._delegate=t,this},needRedraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this.drawLayer,this)),this},_onLayerDidResize:function(t){this._canvas.width=t.newSize.x,this._canvas.height=t.newSize.y},_onLayerDidMove:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t),this.drawLayer()},getEvents:function(){var t={resize:this._onLayerDidResize,moveend:this._onLayerDidMove};return this._map.options.zoomAnimation&&L.Browser.any3d&&(t.zoomanim=this._animateZoom),t},onAdd:function(t){this._map=t,this._canvas=L.DomUtil.create("canvas","leaflet-layer"),this.tiles={};var n=this._map.getSize();this._canvas.width=n.x,this._canvas.height=n.y;var o=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(o?"animated":"hide")),t._panes.overlayPane.appendChild(this._canvas),t.on(this.getEvents(),this);var e=this._delegate||this;e.onLayerDidMount&&e.onLayerDidMount(),this.needRedraw()},onRemove:function(t){var n=this._delegate||this;n.onLayerWillUnmount&&n.onLayerWillUnmount(),t.getPanes().overlayPane.removeChild(this._canvas),t.off(this.getEvents(),this),this._canvas=null},addTo:function(t){return t.addLayer(this),this},LatLonToMercator:function(t){return{x:6378137*t.lng*Math.PI/180,y:6378137*Math.log(Math.tan((90+t.lat)*Math.PI/360))}},drawLayer:function(){var t=this._map.getSize(),n=this._map.getBounds(),o=this._map.getZoom(),e=this.LatLonToMercator(this._map.getCenter()),i=this.LatLonToMercator(this._map.containerPointToLatLng(this._map.getSize())),a=this._delegate||this;a.onDrawLayer&&a.onDrawLayer({layer:this,canvas:this._canvas,bounds:n,size:t,zoom:o,center:e,corner:i}),this._frame=null},_setTransform:function(t,n,o){var e=n||new L.Point(0,0);t.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+e.x+"px,"+e.y+"px)":"translate3d("+e.x+"px,"+e.y+"px,0)")+(o?" scale("+o+")":"")},_animateZoom:function(t){var n=this._map.getZoomScale(t.zoom),o=L.Layer?this._map._latLngToNewLayerPoint(this._map.getBounds().getNorthWest(),t.zoom,t.center):this._map._getCenterOffset(t.center)._multiplyBy(-n).subtract(this._map._getMapPanePos());L.DomUtil.setTransform(this._canvas,o,n)}}),L.canvasLayer=function(){return new L.CanvasLayer};var Windy=function(t){var n,o,e,i,a,r,s,l,c,h,u=15,d=10,f=.005*(Math.pow(window.devicePixelRatio,1/3)||1),_=90,m=1,p=.005,y=Math.pow(window.devicePixelRatio,1/3)||1.6,v=15,g=1e3/v,L=[NaN,NaN,null],M=function(t,n,o,e,i,a){var r=1-t,s=1-n,l=r*s,c=t*s,h=r*n,u=t*n,d=o[0]*l+e[0]*c+i[0]*h+a[0]*u,f=o[1]*l+e[1]*c+i[1]*h+a[1]*u;return[d,f,Math.sqrt(d*d+f*f)]},w=function(t,n){var o=t.data,e=n.data;return{header:t.header,data:function(t){return[o[t],e[t]]},interpolate:M}},x=function(t){var n=null,o=null,e=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"2,2":n=t;break;case"2,3":o=t;break;default:e=t}}),w(n,o)},b=function(t,h){n=x(t);var u=n.header;i=u.lo1,a=u.la1,r=u.dx,s=u.dy,l=u.nx,c=u.ny,e=new Date(u.refTime),e.setHours(e.getHours()+u.forecastTime),o=[];for(var d=0,f=Math.floor(l*r)>=360,_=0;_<c;_++){for(var m=[],p=0;p<l;p++,d++)m[p]=n.data(d);f&&m.push(m[0]),o[_]=m}h({date:e,interpolate:P})},P=function(t,e){if(!o)return null;var l,c=C(t-i,360)/r,h=(a-e)/s,u=Math.floor(c),d=u+1,f=Math.floor(h),_=f+1;if(l=o[f]){var m=l[u],p=l[d];if(D(m)&&D(p)&&(l=o[_])){var y=l[u],v=l[d];if(D(y)&&D(v))return n.interpolate(c-u,h-f,m,p,y,v)}}return null},D=function(t){return null!==t&&void 0!==t},C=function(t,n){return t-n*Math.floor(t/n)},T=function(){return/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)},S=function(t,n,o,e,i,a,r,s){var l=r[0]*a,c=r[1]*a,h=z(t,n,o,e,i,s);return r[0]=h[0]*l+h[2]*c,r[1]=h[1]*l+h[3]*c,r},z=function(t,n,o,e,i,a){var r=2*Math.PI,s=Math.pow(10,-5.2),l=n<0?s:-s,c=o<0?s:-s,h=E(o,n+l,a),u=E(o+c,n,a),d=Math.cos(o/360*r);return[(h[0]-e)/l/d,(h[1]-i)/l/d,(u[0]-e)/c,(u[1]-i)/c]},R=function(t,n,o){function e(n,o){var e=t[Math.round(n)];return e&&e[Math.round(o)]||L}e.release=function(){t=[]},e.randomize=function(t){var o,i,a=0;do o=Math.round(Math.floor(Math.random()*n.width)+n.x),i=Math.round(Math.floor(Math.random()*n.height)+n.y);while(null===e(o,i)[2]&&a++<30);return t.x=o,t.y=i,t},o(n,e)},W=function(t,n,o){var e=t[0],i=t[1],a=Math.round(e[0]),r=Math.max(Math.floor(e[1],0),0),s=(Math.min(Math.ceil(i[0],n),n-1),Math.min(Math.ceil(i[1],o),o-1));return{x:a,y:r,xMax:n,yMax:s,width:n,height:o}},A=function(t){return t/180*Math.PI},U=function(t){return t/(Math.PI/180)},I=function(t,n,o){var e=o.east-o.west,i=o.width/U(e)*360/(2*Math.PI),a=i/2*Math.log((1+Math.sin(o.south))/(1-Math.sin(o.south))),r=o.height+a,s=(r-n)/i,l=180/Math.PI*(2*Math.atan(Math.exp(s))-Math.PI/2),c=U(o.west)+t/o.width*U(e);return[c,l]},N=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},E=function(t,n,o){var e=N(o.south),i=N(o.north),a=o.width/(o.east-o.west),r=o.height/(i-e),s=N(A(t)),l=(A(n)-o.west)*a,s=(i-s)*r;return[l,s]},F=function(t,n,o,e){function i(e){for(var i=[],l=n.y;l<=n.yMax;l+=2){var c=I(e,l,o);if(c){var h=c[0],u=c[1];if(isFinite(h)){var d=t.interpolate(h,u);d&&(d=S(a,h,u,e,l,r,d,o),i[l+1]=i[l]=d)}}}s[e+1]=s[e]=i}var a={},r=f,s=[],l=n.x;!function c(){for(var t=Date.now();l<n.width;)if(i(l),l+=2,Date.now()-t>1e3)return void setTimeout(c,25);R(s,n,e)}()},O=function(n,o){function e(t,n){var o=["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"];return o.indexFor=function(t){return Math.floor(Math.min(t,n)/n*(o.length-1))},o}function i(){s.forEach(function(t){t.length=0}),f.forEach(function(t){t.age>_&&(o.randomize(t).age=0);var n=t.x,e=t.y,i=o(n,e),a=i[2];if(null===a)t.age=_;else{var l=n+i[0],c=e+i[1];null!==o(l,c)[2]?(t.xt=l,t.yt=c,s[r.indexFor(a)].push(t)):(t.x=l,t.y=c)}t.age+=1})}function a(){var t="lighter";L.globalCompositeOperation="destination-in",L.fillRect(n.x,n.y,n.width,n.height),L.globalCompositeOperation=t,L.globalAlpha=.9,s.forEach(function(t,n){t.length>0&&(L.beginPath(),L.strokeStyle=r[n],t.forEach(function(t){L.moveTo(t.x,t.y),L.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),L.stroke())})}var r=e(u,d),s=r.map(function(){return[]}),l=Math.round(n.width*n.height*p);T()&&(l*=y);for(var c="rgba(0, 0, 0, 0.97)",f=[],v=0;v<l;v++)f.push(o.randomize({age:Math.floor(Math.random()*_)+0}));var L=t.canvas.getContext("2d");L.lineWidth=m,L.fillStyle=c,L.globalAlpha=.6;var M=Date.now();!function w(){h=requestAnimationFrame(w);var t=Date.now(),n=t-M;n>g&&(M=t-n%g,i(),a())}()},k=function(n,o,e,i){var a={south:A(i[0][1]),north:A(i[1][1]),east:A(i[1][0]),west:A(i[0][0]),width:o,height:e};V(),b(t.data,function(t){F(t,W(n,o,e),a,function(t,n){q.field=n,O(t,n)})})},V=function(){q.field&&q.field.release(),h&&cancelAnimationFrame(h)},q={params:t,start:k,stop:V,createField:R,interpolatePoint:P};return q};window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)}),L.Control.VelocityPosition=L.Control.extend({options:{position:"bottomleft",emptyString:"Unavailable"},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-velocity-position"),L.DomEvent.disableClickPropagation(this._container),t.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this._container},onRemove:function(t){t.off("mousemove",this._onMouseMove,this)},vectorToSpeed:function(t,n){var o=Math.sqrt(Math.pow(t,2)+Math.pow(n,2));return o},vectorToDegrees:function(t,n){var o=Math.sqrt(Math.pow(t,2)+Math.pow(n,2)),e=Math.atan2(t/o,n/o),i=180*e/Math.PI,a=i+180;return a.toFixed(3)},_onMouseMove:function(t){var n=this,o=this.options.leafletVelocity._map.containerPointToLatLng(L.point(t.containerPoint.x,t.containerPoint.y)),e=this.options.leafletVelocity._windy.interpolatePoint(o.lng,o.lat),i="";if(e&&!isNaN(e[0])&&!isNaN(e[1])&&e[2]){var a=e[1];a=a>0?a-=2*a:Math.abs(a),i="<strong>Velocity Direction: </strong>"+n.vectorToDegrees(e[0],a)+"Â°, <strong>Velocity Speed: </strong>"+n.vectorToSpeed(e[0],a).toFixed(1)+"m/s"}else i="no velocity data";n._container.innerHTML=i,0==$(".leaflet-control-velocity-position").index()&&$(".leaflet-control-velocity-position").insertAfter(".leaflet-control-mouseposition")}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.velocityPosition=function(t){return new L.Control.VelocityPosition(t)},function(t,n){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=n(require("leaflet-velocity")):"function"==typeof define&&define.amd?define(["leaflet-velocity"],function(o){return t.returnExportsGlobal=n(window)}):window.LeafletVelocity=n(window)}(void 0,function(t){var n={_map:null,_data:null,_options:null,_canvasLayer:null,_windy:null,_context:null,_timer:0,_mouseControl:null,init:function(t){n._checkWind(t).then(function(){n._map=t.map,n._options=t,n._canvasLayer=L.canvasLayer().delegate(n),n._options.layerControl.addOverlay(n._canvasLayer,"velocity"),n._map.on("overlayremove",function(t){t.layer==n._canvasLayer&&n._destroyWind()})})["catch"](function(t){console.log("err"),n._options.errorCallback(t)})},setTime:function(t){n._options.timeISO=t},_checkWind:function(t){return new Promise(function(n,o){t.localMode&&n(!0),$.ajax({type:"GET",url:t.pingUrl,error:function(t){o(t)},success:function(t){n(t)}})})},_getRequestUrl:function(){if(!this._options.useNearest)return this._options.latestUrl;var t={timeIso:this._options.timeISO||(new Date).toISOString(),searchLimit:this._options.nearestDaysLimit||7};return this._options.nearestUrl+"?"+$.param(t)},_loadLocalData:function(){console.log("using local data.."),$.getJSON("velocity.json",function(t){n._data=t,n._initWindy(t)})},_loadWindData:function(){if(this._options.localMode)return void this._loadLocalData();var t=this._getRequestUrl();console.log(t),$.ajax({type:"GET",url:t,error:function(t){console.log("error loading data"),n._options.errorCallback(t)||console.log(t),n._loadLocalData()},success:function(t){n._data=t,n._initWindy(t)}})},onDrawLayer:function(t,o){return n._windy?(this._timer&&clearTimeout(n._timer),void(this._timer=setTimeout(function(){var t=n._map.getBounds(),o=n._map.getSize();n._windy.start([[0,0],[o.x,o.y]],o.x,o.y,[[t._southWest.lng,t._southWest.lat],[t._northEast.lng,t._northEast.lat]])},750))):void n._loadWindData()},_initWindy:function(t){this._windy=new Windy({canvas:n._canvasLayer._canvas,data:t}),this._context=this._canvasLayer._canvas.getContext("2d"),this._canvasLayer._canvas.classList.add("velocity-overlay"),this.onDrawLayer(),this._map.on("dragstart",n._windy.stop),this._map.on("dragend",n._clearAndRestart),this._map.on("zoomstart",n._windy.stop),this._map.on("zoomend",n._clearAndRestart),this._map.on("resize",n._clearWind),this._initMouseHandler()},_initMouseHandler:function(){if(!this._mouseControl&&this._options.displayValues){var t=this._options.displayOptions||{};t.leafletVelocity=n,this._mouseControl=L.control.velocityPosition(t).addTo(this._map)}},_clearAndRestart:function(){n._context&&n._context.clearRect(0,0,3e3,3e3),n._windy&&n._windy.start},_clearWind:function(){n._windy&&n._windy.stop(),n._context&&n._context.clearRect(0,0,3e3,3e3)},_destroyWind:function(){this._timer&&clearTimeout(this._timer),this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3),this._mouseControl&&this._map.removeControl(this._mouseControl),this._mouseControl=null,this._windy=null,this._map.removeLayer(this._canvasLayer)}};return n});
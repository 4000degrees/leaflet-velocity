"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};L.DomUtil.setTransform=L.DomUtil.setTransform||function(t,n,e){var o=n||new L.Point(0,0);t.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+o.x+"px,"+o.y+"px)":"translate3d("+o.x+"px,"+o.y+"px,0)")+(e?" scale("+e+")":"")},L.CanvasLayer=(L.Layer?L.Layer:L.Class).extend({initialize:function(t){this._map=null,this._canvas=null,this._frame=null,this._delegate=null,L.setOptions(this,t)},delegate:function(t){return this._delegate=t,this},needRedraw:function(){return this._frame||(this._frame=L.Util.requestAnimFrame(this.drawLayer,this)),this},_onLayerDidResize:function(t){this._canvas.width=t.newSize.x,this._canvas.height=t.newSize.y},_onLayerDidMove:function(){var t=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setPosition(this._canvas,t),this.drawLayer()},getEvents:function(){var t={resize:this._onLayerDidResize,moveend:this._onLayerDidMove};return this._map.options.zoomAnimation&&L.Browser.any3d&&(t.zoomanim=this._animateZoom),t},onAdd:function(t){this._map=t,this._canvas=L.DomUtil.create("canvas","leaflet-layer"),this.tiles={};var n=this._map.getSize();this._canvas.width=n.x,this._canvas.height=n.y;var e=this._map.options.zoomAnimation&&L.Browser.any3d;L.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(e?"animated":"hide")),t._panes.overlayPane.appendChild(this._canvas),t.on(this.getEvents(),this);var o=this._delegate||this;o.onLayerDidMount&&o.onLayerDidMount(),this.needRedraw()},onRemove:function(t){var n=this._delegate||this;n.onLayerWillUnmount&&n.onLayerWillUnmount(),t.getPanes().overlayPane.removeChild(this._canvas),t.off(this.getEvents(),this),this._canvas=null},addTo:function(t){return t.addLayer(this),this},LatLonToMercator:function(t){return{x:6378137*t.lng*Math.PI/180,y:6378137*Math.log(Math.tan((90+t.lat)*Math.PI/360))}},drawLayer:function(){var t=this._map.getSize(),n=this._map.getBounds(),e=this._map.getZoom(),o=this.LatLonToMercator(this._map.getCenter()),a=this.LatLonToMercator(this._map.containerPointToLatLng(this._map.getSize())),i=this._delegate||this;i.onDrawLayer&&i.onDrawLayer({layer:this,canvas:this._canvas,bounds:n,size:t,zoom:e,center:o,corner:a}),this._frame=null},_setTransform:function(t,n,e){var o=n||new L.Point(0,0);t.style[L.DomUtil.TRANSFORM]=(L.Browser.ie3d?"translate("+o.x+"px,"+o.y+"px)":"translate3d("+o.x+"px,"+o.y+"px,0)")+(e?" scale("+e+")":"")},_animateZoom:function(t){var n=this._map.getZoomScale(t.zoom),e=L.Layer?this._map._latLngToNewLayerPoint(this._map.getBounds().getNorthWest(),t.zoom,t.center):this._map._getCenterOffset(t.center)._multiplyBy(-n).subtract(this._map._getMapPanePos());L.DomUtil.setTransform(this._canvas,e,n)}}),L.canvasLayer=function(){return new L.CanvasLayer};var Windy=function(t){var n,e,o,a,i,r,s,l,h,c,u=15,d=10,f=.005*(Math.pow(window.devicePixelRatio,1/3)||1),m=90,_=1,y=.005,v=Math.pow(window.devicePixelRatio,1/3)||1.6,p=15,g=1e3/p,L=[NaN,NaN,null],w=function(t,n,e,o,a,i){var r=1-t,s=1-n,l=r*s,h=t*s,c=r*n,u=t*n,d=e[0]*l+o[0]*h+a[0]*c+i[0]*u,f=e[1]*l+o[1]*h+a[1]*c+i[1]*u;return[d,f,Math.sqrt(d*d+f*f)]},M=function(t,n){var e=t.data,o=n.data;return{header:t.header,data:function(t){return[e[t],o[t]]},interpolate:w}},x=function(t){var n=null,e=null,o=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"2,2":n=t;break;case"2,3":e=t;break;default:o=t}}),M(n,e)},b=function(t,c){n=x(t);var u=n.header;a=u.lo1,i=u.la1,r=u.dx,s=u.dy,l=u.nx,h=u.ny,o=new Date(u.refTime),o.setHours(o.getHours()+u.forecastTime),e=[];for(var d=0,f=Math.floor(l*r)>=360,m=0;m<h;m++){for(var _=[],y=0;y<l;y++,d++)_[y]=n.data(d);f&&_.push(_[0]),e[m]=_}c({date:o,interpolate:P})},P=function(t,o){if(!e)return null;var l,h=T(t-a,360)/r,c=(i-o)/s,u=Math.floor(h),d=u+1,f=Math.floor(c),m=f+1;if(l=e[f]){var _=l[u],y=l[d];if(C(_)&&C(y)&&(l=e[m])){var v=l[u],p=l[d];if(C(v)&&C(p))return n.interpolate(h-u,c-f,_,y,v,p)}}return null},C=function(t){return null!==t&&void 0!==t},T=function(t,n){return t-n*Math.floor(t/n)},D=function(){return/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)},z=function(t,n,e,o,a,i,r,s){var l=r[0]*i,h=r[1]*i,c=S(t,n,e,o,a,s);return r[0]=c[0]*l+c[2]*h,r[1]=c[1]*l+c[3]*h,r},S=function(t,n,e,o,a,i){var r=2*Math.PI,s=Math.pow(10,-5.2),l=n<0?s:-s,h=e<0?s:-s,c=E(e,n+l,i),u=E(e+h,n,i),d=Math.cos(e/360*r);return[(c[0]-o)/l/d,(c[1]-a)/l/d,(u[0]-o)/h,(u[1]-a)/h]},R=function(t,n,e){function o(n,e){var o=t[Math.round(n)];return o&&o[Math.round(e)]||L}o.release=function(){t=[]},o.randomize=function(t){var e,a,i=0;do e=Math.round(Math.floor(Math.random()*n.width)+n.x),a=Math.round(Math.floor(Math.random()*n.height)+n.y);while(null===o(e,a)[2]&&i++<30);return t.x=e,t.y=a,t},e(n,o)},A=function(t,n,e){var o=t[0],a=t[1],i=Math.round(o[0]),r=Math.max(Math.floor(o[1],0),0),s=(Math.min(Math.ceil(a[0],n),n-1),Math.min(Math.ceil(a[1],e),e-1));return{x:i,y:r,xMax:n,yMax:s,width:n,height:e}},N=function(t){return t/180*Math.PI},W=function(t){return t/(Math.PI/180)},F=function(t,n,e){var o=e.east-e.west,a=e.width/W(o)*360/(2*Math.PI),i=a/2*Math.log((1+Math.sin(e.south))/(1-Math.sin(e.south))),r=e.height+i,s=(r-n)/a,l=180/Math.PI*(2*Math.atan(Math.exp(s))-Math.PI/2),h=W(e.west)+t/e.width*W(o);return[h,l]},U=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},E=function(t,n,e){var o=U(e.south),a=U(e.north),i=e.width/(e.east-e.west),r=e.height/(a-o),s=U(N(t)),l=(N(n)-e.west)*i,s=(a-s)*r;return[l,s]},I=function(t,n,e,o){function a(o){for(var a=[],l=n.y;l<=n.yMax;l+=2){var h=F(o,l,e);if(h){var c=h[0],u=h[1];if(isFinite(c)){var d=t.interpolate(c,u);d&&(d=z(i,c,u,o,l,r,d,e),a[l+1]=a[l]=d)}}}s[o+1]=s[o]=a}var i={},r=f,s=[],l=n.x;!function h(){for(var t=Date.now();l<n.width;)if(a(l),l+=2,Date.now()-t>1e3)return void setTimeout(h,25);R(s,n,o)}()},O=function(n,e){function o(t,n){var e=["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"];return e.indexFor=function(t){return Math.floor(Math.min(t,n)/n*(e.length-1))},e}function a(){s.forEach(function(t){t.length=0}),f.forEach(function(t){t.age>m&&(e.randomize(t).age=0);var n=t.x,o=t.y,a=e(n,o),i=a[2];if(null===i)t.age=m;else{var l=n+a[0],h=o+a[1];null!==e(l,h)[2]?(t.xt=l,t.yt=h,s[r.indexFor(i)].push(t)):(t.x=l,t.y=h)}t.age+=1})}function i(){var t="lighter";L.globalCompositeOperation="destination-in",L.fillRect(n.x,n.y,n.width,n.height),L.globalCompositeOperation=t,L.globalAlpha=.9,s.forEach(function(t,n){t.length>0&&(L.beginPath(),L.strokeStyle=r[n],t.forEach(function(t){L.moveTo(t.x,t.y),L.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),L.stroke())})}var r=o(u,d),s=r.map(function(){return[]}),l=Math.round(n.width*n.height*y);D()&&(l*=v);for(var h="rgba(0, 0, 0, 0.97)",f=[],p=0;p<l;p++)f.push(e.randomize({age:Math.floor(Math.random()*m)+0}));var L=t.canvas.getContext("2d");L.lineWidth=_,L.fillStyle=h,L.globalAlpha=.6;var w=Date.now();!function M(){c=requestAnimationFrame(M);var t=Date.now(),n=t-w;n>g&&(w=t-n%g,a(),i())}()},V=function(n,e,o,a){var i={south:N(a[0][1]),north:N(a[1][1]),east:N(a[1][0]),west:N(a[0][0]),width:e,height:o};B(),b(t.data,function(t){I(t,A(n,e,o),i,function(t,n){k.field=n,O(t,n)})})},B=function(){k.field&&k.field.release(),c&&cancelAnimationFrame(c)},k={params:t,start:V,stop:B,createField:R,interpolatePoint:P};return k};window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)}),L.Control.VelocityPosition=L.Control.extend({options:{position:"bottomleft",emptyString:"Unavailable"},onAdd:function(t){return this._container=L.DomUtil.create("div","leaflet-control-velocity-position"),L.DomEvent.disableClickPropagation(this._container),t.on("mousemove",this._onMouseMove,this),this._container.innerHTML=this.options.emptyString,this._container},onRemove:function(t){t.off("mousemove",this._onMouseMove,this)},vectorToSpeed:function(t,n){var e=Math.sqrt(Math.pow(t,2)+Math.pow(n,2));return e},vectorToDegrees:function(t,n){var e=Math.sqrt(Math.pow(t,2)+Math.pow(n,2)),o=Math.atan2(t/e,n/e),a=180*o/Math.PI,i=a+180;return i.toFixed(3)},_onMouseMove:function(t){var n=this,e=this.options.leafletVelocity._map.containerPointToLatLng(L.point(t.containerPoint.x,t.containerPoint.y)),o=this.options.leafletVelocity._windy.interpolatePoint(e.lng,e.lat),a="";if(o&&!isNaN(o[0])&&!isNaN(o[1])&&o[2]){var i=o[1];i=i>0?i-=2*i:Math.abs(i),a="<strong>Velocity Direction: </strong>"+n.vectorToDegrees(o[0],i)+"Â°, <strong>Velocity Speed: </strong>"+n.vectorToSpeed(o[0],i).toFixed(1)+"m/s"}else a="no velocity data";n._container.innerHTML=a,0==$(".leaflet-control-velocity-position").index()&&$(".leaflet-control-velocity-position").insertAfter(".leaflet-control-mouseposition")}}),L.Map.mergeOptions({positionControl:!1}),L.Map.addInitHook(function(){this.options.positionControl&&(this.positionControl=new L.Control.MousePosition,this.addControl(this.positionControl))}),L.control.velocityPosition=function(t){return new L.Control.VelocityPosition(t)},function(t,n){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=n(require("leaflet-velocity")):"function"==typeof define&&define.amd?define(["leaflet-velocity"],function(e){return t.returnExportsGlobal=n(window)}):window.LeafletVelocity=n(window)}(void 0,function(t){var n={_map:null,_data:null,_options:null,_canvasLayer:null,_windy:null,_context:null,_timer:0,_mouseControl:null,init:function(t){n._map=t.map,n._data=t.data,n._options=t,n._canvasLayer=L.canvasLayer().delegate(n),n._options.layerControl.addOverlay(n._canvasLayer,t.overlayName||"velocity"),n._map.on("overlayremove",function(t){t.layer==n._canvasLayer&&n._destroyWind()})},setTime:function(t){n._options.timeISO=t},onDrawLayer:function(t,e){return n._windy?(this._timer&&clearTimeout(n._timer),void(this._timer=setTimeout(function(){var t=n._map.getBounds(),e=n._map.getSize();n._windy.start([[0,0],[e.x,e.y]],e.x,e.y,[[t._southWest.lng,t._southWest.lat],[t._northEast.lng,t._northEast.lat]])},750))):void n._initWindy(n._data)},_initWindy:function(t){console.log("init windy"),console.log(t),console.log(n),this._windy=new Windy({canvas:n._canvasLayer._canvas,data:t}),this._context=this._canvasLayer._canvas.getContext("2d"),this._canvasLayer._canvas.classList.add("velocity-overlay"),this.onDrawLayer(),this._map.on("dragstart",n._windy.stop),this._map.on("dragend",n._clearAndRestart),this._map.on("zoomstart",n._windy.stop),this._map.on("zoomend",n._clearAndRestart),this._map.on("resize",n._clearWind),this._initMouseHandler()},_initMouseHandler:function(){if(!this._mouseControl&&this._options.displayValues){var t=this._options.displayOptions||{};t.leafletVelocity=n,this._mouseControl=L.control.velocityPosition(t).addTo(this._map)}},_clearAndRestart:function(){n._context&&n._context.clearRect(0,0,3e3,3e3),n._windy&&n._windy.start},_clearWind:function(){n._windy&&n._windy.stop(),n._context&&n._context.clearRect(0,0,3e3,3e3)},_destroyWind:function(){this._timer&&clearTimeout(this._timer),this._windy&&this._windy.stop(),this._context&&this._context.clearRect(0,0,3e3,3e3),this._mouseControl&&this._map.removeControl(this._mouseControl),this._mouseControl=null,this._windy=null,this._map.removeLayer(this._canvasLayer)}};return n});